import os
import requests
import json

SAVE_DIR = "data/laws_raw"
os.makedirs(SAVE_DIR, exist_ok=True)

# –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∑–∞–∫–æ–Ω—ã –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞
links = {
    "constitution_kz.txt": "https://adilet.zan.kz/_next/data/S7qemvbvmdYz0h7NK7Fzn/ru/docs/K950001000.json",
    "civil_code_kz.txt": "https://adilet.zan.kz/_next/data/S7qemvbvmdYz0h7NK7Fzn/ru/docs/K940004100.json", 
    "consumer_law_kz.txt": "https://adilet.zan.kz/_next/data/S7qemvbvmdYz0h7NK7Fzn/ru/docs/K040000576.json",
    "admin_code_kz.txt": "https://adilet.zan.kz/_next/data/S7qemvbvmdYz0h7NK7Fzn/ru/docs/K070000155.json",
    "labor_code_kz.txt": "https://adilet.zan.kz/_next/data/S7qemvbvmdYz0h7NK7Fzn/ru/docs/K150000414.json"
}

def extract_text(json_data):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—ã adilet.zan.kz"""
    try:
        # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        if "pageProps" in json_data and "data" in json_data["pageProps"]:
            content = json_data["pageProps"]["data"]
            
            if "content" in content:
                body = content["content"]
                text = []
                
                for block in body:
                    if isinstance(block, dict):
                        if block.get("type") == "text" and "data" in block:
                            text.append(block["data"].get("text", ""))
                        elif "text" in block:
                            text.append(block["text"])
                        elif "content" in block:
                            text.append(str(block["content"]))
                
                return "\n".join(text)
            
            elif "text" in content:
                return content["text"]
                
        # –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –±–µ—Ä–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        def extract_all_text(obj):
            texts = []
            if isinstance(obj, dict):
                for key, value in obj.items():
                    if key in ["text", "content", "title", "heading"] and isinstance(value, str):
                        texts.append(value)
                    elif isinstance(value, (dict, list)):
                        texts.extend(extract_all_text(value))
            elif isinstance(obj, list):
                for item in obj:
                    texts.extend(extract_all_text(item))
            return texts
        
        all_texts = extract_all_text(json_data)
        if all_texts:
            return "\n".join(all_texts)
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: {e}")
        
    return None

def download_fallback_texts():
    """–°–æ–∑–¥–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –µ—Å–ª–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–µ—Ç—Å—è"""
    fallback_texts = {
        "constitution_kz.txt": """
–ö–û–ù–°–¢–ò–¢–£–¶–ò–Ø –†–ï–°–ü–£–ë–õ–ò–ö–ò –ö–ê–ó–ê–•–°–¢–ê–ù

–°—Ç–∞—Ç—å—è 1. –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω –ø—Ä–æ–≤–æ–∑–≥–ª–∞—à–∞–µ—Ç —Å–µ–±—è –¥–µ–º–æ–∫—Ä–∞—Ç–∏—á–µ—Å–∫–∏–º, —Å–≤–µ—Ç—Å–∫–∏–º, –ø—Ä–∞–≤–æ–≤—ã–º –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–º –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ–º, –≤—ã—Å—à–∏–º–∏ —Ü–µ–Ω–Ω–æ—Å—Ç—è–º–∏ –∫–æ—Ç–æ—Ä–æ–≥–æ —è–≤–ª—è—é—Ç—Å—è —á–µ–ª–æ–≤–µ–∫, –µ–≥–æ –∂–∏–∑–Ω—å, –ø—Ä–∞–≤–∞ –∏ —Å–≤–æ–±–æ–¥—ã.

–°—Ç–∞—Ç—å—è 12. –í –†–µ—Å–ø—É–±–ª–∏–∫–µ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω –ø—Ä–∏–∑–Ω–∞—é—Ç—Å—è –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∏ —Å–≤–æ–±–æ–¥—ã —á–µ–ª–æ–≤–µ–∫–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –Ω–∞—Å—Ç–æ—è—â–µ–π –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–µ–π.

–°—Ç–∞—Ç—å—è 13. –ö–∞–∂–¥—ã–π –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –Ω–∞ –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ –µ–≥–æ –ø—Ä–∞–≤–æ—Å—É–±—ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –∏ –≤–ø—Ä–∞–≤–µ –∑–∞—â–∏—â–∞—Ç—å —Å–≤–æ–∏ –ø—Ä–∞–≤–∞ –∏ —Å–≤–æ–±–æ–¥—ã –≤—Å–µ–º–∏ –Ω–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—â–∏–º–∏ –∑–∞–∫–æ–Ω—É —Å–ø–æ—Å–æ–±–∞–º–∏.

–°—Ç–∞—Ç—å—è 26. –ì—Ä–∞–∂–¥–∞–Ω–µ –†–µ—Å–ø—É–±–ª–∏–∫–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω –º–æ–≥—É—Ç –∏–º–µ—Ç—å –≤ —á–∞—Å—Ç–Ω–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –ª—é–±–æ–µ –∑–∞–∫–æ–Ω–Ω–æ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–Ω–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ.
        """,
        
        "civil_code_kz.txt": """
–ì–†–ê–ñ–î–ê–ù–°–ö–ò–ô –ö–û–î–ï–ö–° –†–ï–°–ü–£–ë–õ–ò–ö–ò –ö–ê–ó–ê–•–°–¢–ê–ù

–°—Ç–∞—Ç—å—è 1. –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—á–∞–ª–∞ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–≥–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞
1. –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–µ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ –æ—Å–Ω–æ–≤—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –ø—Ä–∏–∑–Ω–∞–Ω–∏–∏ —Ä–∞–≤–µ–Ω—Å—Ç–≤–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Ä–µ–≥—É–ª–∏—Ä—É–µ–º—ã—Ö –∏–º –æ—Ç–Ω–æ—à–µ–Ω–∏–π, –Ω–µ–ø—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–Ω–æ—Å—Ç–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏, —Å–≤–æ–±–æ–¥—ã –¥–æ–≥–æ–≤–æ—Ä–∞.

–°—Ç–∞—Ç—å—è 188. –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø—Ä–∞–≤–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏  
1. –°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫—É –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç –ø—Ä–∞–≤–∞ –≤–ª–∞–¥–µ–Ω–∏—è, –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ —Ä–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏—è —Å–≤–æ–∏–º –∏–º—É—â–µ—Å—Ç–≤–æ–º.

–°—Ç–∞—Ç—å—è 269. –ü–æ–Ω—è—Ç–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞
1. –í —Å–∏–ª—É –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –æ–¥–Ω–æ –ª–∏—Ü–æ (–¥–æ–ª–∂–Ω–∏–∫) –æ–±—è–∑–∞–Ω–æ —Å–æ–≤–µ—Ä—à–∏—Ç—å –≤ –ø–æ–ª—å–∑—É –¥—Ä—É–≥–æ–≥–æ –ª–∏—Ü–∞ (–∫—Ä–µ–¥–∏—Ç–æ—Ä–∞) –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.

–°—Ç–∞—Ç—å—è 380. –ü–æ–Ω—è—Ç–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞
1. –î–æ–≥–æ–≤–æ—Ä–æ–º –ø—Ä–∏–∑–Ω–∞–µ—Ç—Å—è —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –¥–≤—É—Ö –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ª–∏—Ü –æ–± —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏, –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–ª–∏ –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–∏ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏—Ö –ø—Ä–∞–≤ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–µ–π.
        """,
        
        "consumer_law_kz.txt": """
–ó–ê–ö–û–ù –†–ï–°–ü–£–ë–õ–ò–ö–ò –ö–ê–ó–ê–•–°–¢–ê–ù "–û –ó–ê–©–ò–¢–ï –ü–†–ê–í –ü–û–¢–†–ï–ë–ò–¢–ï–õ–ï–ô"

–°—Ç–∞—Ç—å—è 1. –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è
–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å - —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ, –ø—Ä–∏–æ–±—Ä–µ—Ç–∞—é—â–µ–µ, –∑–∞–∫–∞–∑—ã–≤–∞—é—â–∏–µ –ª–∏–±–æ –Ω–∞–º–µ—Ä–µ–≤–∞—é—â–∏–µ—Å—è –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ —Ç–æ–≤–∞—Ä—ã –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è –ª–∏—á–Ω—ã—Ö –Ω—É–∂–¥.

–°—Ç–∞—Ç—å—è 4. –ü—Ä–∞–≤–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ –∏ –µ–≥–æ –∏–∑–≥–æ—Ç–æ–≤–∏—Ç–µ–ª–µ.

–°—Ç–∞—Ç—å—è 16. –ü—Ä–∞–≤–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è –Ω–∞ –æ–±–º–µ–Ω —Ç–æ–≤–∞—Ä–∞ –Ω–∞–¥–ª–µ–∂–∞—â–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å –≤–ø—Ä–∞–≤–µ –≤ —Ç–µ—á–µ–Ω–∏–µ —á–µ—Ç—ã—Ä–Ω–∞–¥—Ü–∞—Ç–∏ –¥–Ω–µ–π –æ–±–º–µ–Ω—è—Ç—å –Ω–µ–ø—Ä–æ–¥–æ–≤–æ–ª—å—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä –Ω–∞–¥–ª–µ–∂–∞—â–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–∞ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π —Ç–æ–≤–∞—Ä.
        """
    }
    
    print("üìù –°–æ–∑–¥–∞—é —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –∑–∞–∫–æ–Ω–æ–≤...")
    for filename, content in fallback_texts.items():
        path = os.path.join(SAVE_DIR, filename)
        with open(path, "w", encoding="utf-8") as f:
            f.write(content.strip())
        print(f"‚úÖ –°–æ–∑–¥–∞–Ω —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Ñ–∞–π–ª: {path}")

def main():
    print("üèõÔ∏è –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –†–µ—Å–ø—É–±–ª–∏–∫–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω")
    print("=" * 60)
    
    success_count = 0
    
    for filename, url in links.items():
        print(f"üì• –ó–∞–≥—Ä—É–∂–∞—é {filename}...")
        
        try:
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            }
            
            r = requests.get(url, headers=headers, timeout=30)
            
            if r.status_code != 200:
                print(f"‚ùå HTTP –æ—à–∏–±–∫–∞ {r.status_code} –¥–ª—è {filename}")
                continue
                
            try:
                data = r.json()
            except json.JSONDecodeError:
                print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å JSON –¥–ª—è {filename}")
                continue
            
            text = extract_text(data)
            
            if text and len(text.strip()) > 100:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–π
                path = os.path.join(SAVE_DIR, filename)
                with open(path, "w", encoding="utf-8") as f:
                    f.write(text)
                print(f"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {path} ({len(text)} —Å–∏–º–≤–æ–ª–æ–≤)")
                success_count += 1
            else:
                print(f"‚ö†Ô∏è –ü—É—Å—Ç–æ–π –∏–ª–∏ –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç –¥–ª—è {filename}")
                
        except requests.RequestException as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ {filename}: {e}")
        except Exception as e:
            print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –¥–ª—è {filename}: {e}")
    
    print(f"\nüìä –†–µ–∑—É–ª—å—Ç–∞—Ç: {success_count}/{len(links)} —Ñ–∞–π–ª–æ–≤ —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω–æ")
    
    # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–∫–∞—á–∞–ª–æ—Å—å –∏–ª–∏ –æ—á–µ–Ω—å –º–∞–ª–æ, —Å–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ —Ñ–∞–π–ª—ã
    if success_count < 2:
        print("\n‚ö†Ô∏è –ú–∞–ª–æ —Ñ–∞–π–ª–æ–≤ —Å–∫–∞—á–∞–Ω–æ, —Å–æ–∑–¥–∞—é —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã...")
        download_fallback_texts()
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å
    print(f"\nüìÇ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ {SAVE_DIR}:")
    try:
        files = os.listdir(SAVE_DIR)
        for file in files:
            if file.endswith('.txt'):
                filepath = os.path.join(SAVE_DIR, file)
                size = os.path.getsize(filepath)
                print(f"  üìÑ {file} ({size:,} –±–∞–π—Ç)")
        print(f"\n–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: {len([f for f in files if f.endswith('.txt')])}")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –ø–∞–ø–∫–∏: {e}")

if __name__ == "__main__":
    main()